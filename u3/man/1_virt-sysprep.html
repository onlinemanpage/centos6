<!-- Creator     : groff version 1.18.1.4 -->
<!-- CreationDate: Fri Nov 18 04:51:27 2016 -->
<html>
<head>
<meta name="generator" content="groff -Thtml, see www.gnu.org">
<meta name="Content-Style" content="text/css">
<title></title>
</head>
<body>

<hr>

<p>virt-sysprep(1) Virtualization Support
virt-sysprep(1)</p>

<p>NAME virt-sysprep - Reset or unconfigure a virtual
machine so clones can be made</p>

<p>SYNOPSIS virt-sysprep [--options] -d domname</p>

<p>virt-sysprep [--options] -a disk.img [-a disk.img
...]</p>

<p>DESCRIPTION Virt-sysprep &quot;resets&quot; or
&quot;unconfigures&quot; a virtual machine so that clones
can be made from it. Steps in this process include removing
SSH host keys, removing persistent network MAC
configuration, and removing user accounts. Each step can be
enabled or disabled as required.</p>

<p>Virt-sysprep is a simple shell script, allowing easy
inspection or customization by the system administrator.</p>

<p>Virt-sysprep modifies the guest or disk image in place.
The guest must be shut down. If you want to preserve the
existing contents of the guest, you must copy or clone the
disk first. See &quot;COPYING AND CLONING&quot; below.</p>

<p>You do not need to run virt-sysprep as root. In fact wed
generally recommend that you dont. The time you might want
to run it as root is when you need root in order to access
the disk image, but even in this case it would be better to
change the permissions on the disk image to be writable as
the non-root user running virt-sysprep.</p>

<p>&quot;Sysprep&quot; stands for &quot;system
preparation&quot; tool. The name comes from the Microsoft
program &quot;sysprep.exe&quot; which is used to unconfigure
Windows machines in preparation for cloning them. Having
said that, virt-sysprep does not currently work on Microsoft
Windows guests. We plan to support Windows sysprepping in a
future version, and we already have code to do it.</p>

<p>OPTIONS --help Display brief help.</p>

<p>-a file --add file Add file which should be a disk image
from a virtual machine.</p>

<p>The format of the disk image is auto-detected. To
override this and force a particular format use the
--format=.. option.</p>

<p>-c URI --connect URI If using libvirt, connect to the
given URI. If omitted, then we connect to the default
libvirt hypervisor.</p>

<p>If you specify guest block devices directly (-a), then
libvirt is not used at all.</p>

<p>-d guest --domain guest Add all the disks from the named
libvirt guest. Domain UUIDs can be used instead of
names.</p>

<p>--enable=... Choose which sysprep operations to perform.
Give a comma-separated list of operations, for example:</p>

<p>--enable=ssh-hostkeys,udev-persistent-net</p>

<p>would enable ONLY &quot;ssh-hostkeys&quot; and
&quot;udev-persistent-net&quot; operations.</p>

<p>If the --enable option is not given, then we default to
trying all possible sysprep operations. But some sysprep
operations are skipped for some guest types.</p>

<p>Use --list-operations to list operations supported by a
particular version of virt-sysprep.</p>

<p>See &quot;OPERATIONS&quot; below for a list and an
explanation of each operation.</p>

<p>--format=raw|qcow2|.. --format The default for the -a
option is to auto-detect the format of the disk image. Using
this forces the disk format for -a options which follow on
the command line. Using --format with no argument switches
back to auto-detection for subsequent -a options.</p>

<p>For example:</p>

<p>virt-sysprep --format=raw -a disk.img</p>

<p>forces raw format (no auto-detection) for
&quot;disk.img&quot;.</p>

<p>virt-sysprep --format=raw -a disk.img --format -a
another.img</p>

<p>forces raw format (no auto-detection) for
&quot;disk.img&quot; and reverts to auto-detection for
&quot;another.img&quot;.</p>

<p>If you have untrusted raw-format guest disk images, you
should use this option to specify the disk format. This
avoids a possible security problem with malicious guests
(CVE-2010-3851).</p>

<p>--hostname newhostname Change the hostname. See the
&quot;hostname&quot; operation below. If not given, defaults
to &quot;localhost.localdomain&quot;.</p>

<p>--list-operations List the operations supported by the
virt-sysprep program.</p>

<p>--selinux-relabel --no-selinux-relabel --selinux-relabel
forces SELinux relabelling next time the guest boots.
--no-selinux-relabel disables relabelling.</p>

<p>The default is to try to detect if SELinux relabelling
is required. See &quot;SELINUX RELABELLING&quot; below for
more details.</p>

<p>-v --verbose Enable verbose messages for debugging.</p>

<p>-V --version Display version number and exit.</p>

<p>-x Enable tracing of libguestfs API calls.</p>

<p>OPERATIONS If the --enable option is not given, then all
sysprep operations are enabled, although some are skipped
depending on the type of guest.</p>

<p>Operations can be individually enabled using the
--enable option. Use a comma-separated list, for
example:</p>

<p>virt-sysprep --enable=ssh-hostkeys,udev-persistent-net
[etc..]</p>

<p>To list the operations supported by the current version
of virt- sysprep, use --list-operations.</p>

<p>Future versions of virt-sysprep may add more operations.
If you are using virt-sysprep and want predictable
behaviour, specify only the operations that you want to have
enabled.</p>

<p>cron-spool Remove user at-jobs and cron-jobs.</p>

<p>dhcp-client-state Remove DHCP client leases.</p>

<p>dhcp-server-state Remove DHCP server leases.</p>

<p>hostname Changes the hostname of the guest to the value
given in the --hostname parameter.</p>

<p>If the --hostname parameter is not given, then the
hostname is changed to
&quot;localhost.localdomain&quot;.</p>

<p>logfiles Remove many log files.</p>

<p>mail-spool Remove email from the local mail spool
directory.</p>

<p>net-hwaddr Remove HWADDR (hard-coded MAC address)
configuration. For Fedora and Red Hat Enterprise Linux, this
is removed from &quot;ifcfg-*&quot; files.</p>

<p>random-seed Write some random bytes from the host into
the random seed file of the guest.</p>

<p>See &quot;RANDOM SEED&quot; below.</p>

<p>rhn-systemid Remove the RHN system ID.</p>

<p>smolt-uuid Remove the Smolt hardware UUID.</p>

<p>ssh-hostkeys Remove the SSH host keys in the guest.</p>

<p>The SSH host keys are regenerated (differently) next
time the guest is booted.</p>

<p>If, after cloning, the guest gets the same IP address,
ssh will give you a stark warning about the host key
changing:</p>


<p>@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@ WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED! @
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!</p>

<p>udev-persistent-net Remove udev persistent net rules
which map the guests existing MAC address to a fixed
ethernet device (eg. eth0).</p>

<p>After a guest is cloned, the MAC address usually
changes. Since the old MAC address occupies the old name
(eg. eth0), this means the fresh MAC address is assigned to
a new name (eg. eth1) and this is usually undesirable.
Erasing the udev persistent net rules avoids this.</p>

<p>utmp Remove the utmp file.</p>

<p>This records who is currently logged in on a machine. In
modern Linux distros it is stored in a ramdisk and hence not
part of the virtual machines disk, but it was stored on disk
in older distros.</p>

<p>yum-uuid Remove the yum UUID.</p>

<p>Yum creates a fresh UUID the next time it runs when it
notices that the original UUID has been erased.</p>

<p>COPYING AND CLONING Virt-sysprep can be used as part of
a process of cloning guests, or to prepare a template from
which guests can be cloned. There are many different ways to
achieve this using the virt tools, and this section is just
an introduction.</p>

<p>A virtual machine (when switched off) consists of two
parts:</p>

<p>configuration The configuration or description of the
guest. eg. The libvirt XML (see &quot;virsh dumpxml&quot;),
the running configuration of the guest, or another external
format like OVF.</p>

<p>Some configuration items that might need to be
changed:</p>

<p>&middot; name</p>

<p>&middot; UUID</p>

<p>&middot; path to block device(s)</p>

<p>&middot; network card MAC address</p>

<p>block device(s) One or more hard disk images, themselves
containing files, directories, applications, kernels,
configuration, etc.</p>

<p>Some things inside the block devices that might need to
be changed:</p>

<p>&middot; hostname and other net configuration</p>

<p>&middot; UUID</p>

<p>&middot; SSH host keys</p>

<p>&middot; Windows unique security ID (SID)</p>

<p>&middot; Puppet registration</p>

<p>COPYING THE BLOCK DEVICE Starting with an original
guest, you probably wish to copy the guest block device and
its configuration to make a template. Then once you are
happy with the template, you will want to make many clones
from it.</p>

<p>virt-sysprep | v original guest --------&gt; template
----------&gt; &minus;-----&gt; cloned &minus;----&gt;
guests &minus;---&gt;</p>

<p>You can, of course, just copy the block device on the
host using cp(1) or dd(1).</p>

<p>dd dd original guest --------&gt; template
----------&gt; &minus;-----&gt; cloned &minus;----&gt;
guests &minus;---&gt;</p>

<p>There are some smarter (and faster) ways too:</p>

<p>&middot;</p>

<p>snapshot template ----------&gt; &minus;-----&gt; cloned
&minus;----&gt; guests &minus;---&gt;</p>

<p>Use the block device as a backing file and create a
snapshot on top for each guest. The advantage is that you
dont need to copy the block device (very fast) and only
changes are stored (less storage required).</p>

<p>Note that writing to the backing file once you have
created guests on top of it is not possible: you will
corrupt the guests.</p>

<p>Tools that can do this include: qemu-img(1) (with the
create -f qcow2 -o backing_file option), lvcreate(8)
(--snapshot option). Some filesystems (such as btrfs) and
most Network Attached Storage devices can also create cheap
snapshots from files or LUNs.</p>

<p>&middot; Get your NAS to snapshot and/or duplicate the
LUN.</p>

<p>&middot; Prepare your template using virt-sparsify(1).
See below.</p>

<p>VIRT-CLONE A separate tool, virt-clone(1), can be used
to duplicate the block device and/or modify the external
libvirt configuration of a guest. It will reset the name,
UUID and MAC address of the guest in the libvirt XML.</p>

<p>virt-clone(1) does not use libguestfs and cannot look
inside the disk image. This was the original motivation to
write virt-sysprep.</p>

<p>SPARSIFY virt-sparsify original guest --------&gt;
template</p>

<p>virt-sparsify(1) can be used to make the cloning
template smaller, making it easier to compress and/or faster
to copy.</p>

<p>Notice that since virt-sparsify also copies the image,
you can use it to make the initial copy (instead of
&quot;dd&quot;).</p>

<p>RESIZE virt-resize template ----------&gt;
&minus;-----&gt; cloned &minus;----&gt; guests
&minus;---&gt;</p>

<p>If you want to give people cloned guests, but let them
pick the size of the guest themselves (eg. depending on how
much they are prepared to pay for disk space), then instead
of copying the template, you can run virt-resize(1).
Virt-resize performs a copy and resize, and thus is ideal
for cloning guests from a template.</p>

<p>SECURITY Although virt-sysprep removes some sensitive
information from the guest, it does not pretend to remove
all of it. You should examine the &quot;OPERATIONS&quot;
above, and the implementation of the operations in the shell
script. You should also examine the guest afterwards.</p>

<p>Sensitive files are simply removed. The data they
contained may still exist on the disk, easily recovered with
a hex editor or undelete tool. Use virt-sparsify(1) as one
way to remove this content. See also the scrub(1) command to
get rid of deleted content in directory entries and
inodes.</p>

<p>RANDOM SEED (This section applies to Linux guests
only)</p>

<p>The virt-sysprep &quot;random-seed&quot; operation
writes a few bytes of randomness from the host into the
guests random seed file.</p>

<p>If this is just done once and the guest is cloned from
the same template, then each guest will start with the same
entropy, and things like SSH host keys and TCP sequence
numbers may be predictable.</p>

<p>Therefore you should arrange to add more randomness
after cloning from a template too, which can be done by just
enabling the &quot;random-seed&quot; operation:</p>

<p>cp template.img newguest.img virt-sysprep
--enable=random-seed -a newguest.img</p>

<p>SELINUX RELABELLING (This section applies to Linux
guests using SELinux only)</p>

<p>If any new files are created by virt-sysprep, then
virt-sysprep touches &quot;/.autorelabel&quot; so that these
will be correctly labelled by SELinux the next time the
guest is booted. This process interrupts boot and can take
some time.</p>

<p>You can force relabelling for all guests by supplying
the --selinux-relabel option.</p>

<p>You can disable relabelling entirely by supplying the
--no-selinux-relabel option.</p>

<p>SHELL QUOTING Libvirt guest names can contain arbitrary
characters, some of which have meaning to the shell such as
&quot;#&quot; and space. You may need to quote or escape
these characters on the command line. See the shell manual
page sh(1) for details.</p>

<p>EXIT STATUS This program returns 0 on success, or 1 if
there was an error.</p>

<p>SEE ALSO guestfs(3), guestfish(1), virt-clone(1),
virt-rescue(1), virt-resize(1), virt-sparsify(1), virsh(1),
lvcreate(8), qemu-img(1), scrub(1),
&lt;http://libguestfs.org/&gt;,
&lt;http://libvirt.org/&gt;.</p>

<p>AUTHOR Richard W.M. Jones
&lt;http://people.redhat.com/~rjones/&gt;</p>

<p>COPYRIGHT Copyright (C) 2011 Red Hat Inc.</p>

<p>This program is free software; you can redistribute it
and/or modify it under the terms of the GNU General Public
License as published by the Free Software Foundation; either
version 2 of the License, or (at your option) any later
version.</p>

<p>This program is distributed in the hope that it will be
useful, but WITHOUT ANY WARRANTY; without even the implied
warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR
PURPOSE. See the GNU General Public License for more
details.</p>

<p>You should have received a copy of the GNU General
Public License along with this program; if not, write to the
Free Software Foundation, Inc., 51 Franklin Street, Fifth
Floor, Boston, MA 02110-1301 USA.</p>

<p>libguestfs-1.16.19 2012-04-18 virt-sysprep(1)</p>
<hr>
</body>
</html>
